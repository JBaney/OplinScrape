# -*- coding: utf-8 -*-
"""
Created on Wed Jun 10 10:23:21 2020
Script Scrapes the Oplin Website 
@author: jbaney
"""

import requests
import pandas as pd
from bs4 import BeautifulSoup


url ='https://stats.oplin.org/lynda/'

html_content = requests.get(url).text
soup = BeautifulSoup(html_content, 'lxml')
items = soup.select('option[value]')
values = [item.get('value') for item in items]
textValues = [item.text for item in items]
d = {'Library ID': values, 'Library Name': textValues}
libraryDf = pd.DataFrame(data = d)

libraryList = [
'OH0001',
'OH0129',
'OH0002',
'OH0003',
'OH0004',
'OH0006',
'OH0007',
'OH0008',
'OH0009',
'OH0010',
'OH0012',
'OH0156',
'OH0225',
'OH0015',
'OH0016',
'OH0017',
'OH0019',
'OH0020',
'OH0022',
'OH0133',
'OH0023',
'OH0024',
'OH0086',
'OH0025',
'OH0026',
'OH0027',
'OH0028',
'OH0030',
'OH0107',
'OH0031',
'OH0090',
'OH0119',
'OH0221',
'OH0033',
'OH0034',
'OH0036',
'OH0038',
'OH0040',
'OH0073',
'OH0227',
'OH0042',
'OH0044',
'OH0220',
'OH0048',
'OH0204',
'OH0068',
'OH0018',
'OH0053',
'OH0051',
'OH0054',
'OH0055',
'OH0056',
'OH0057',
'OH0210',
'OH0058',
'OH0059',
'OH0061',
'OH0052',
'OH0062',
'OH0063',
'OH0064',
'OH0065',
'OH0066',
'OH0067',
'OH0041',
'OH0070',
'OH0249',
'OH0088',
'OH0072',
'OH0074',
'OH0077',
'OH0078',
'OH0143',
'OH0116',
'OH0079',
'OH0081',
'OH0082',
'OH0083',
'OH0085',
'OH0087',
'OH0229',
'OH0046',
'OH0091',
'OH0092',
'OH0093',
'OH0094',
'OH0175',
'OH0095',
'OH0096',
'OH0247',
'OH0098',
'OH0037',
'OH0013',
'OH0071',
'OH0076',
'OH0109',
'OH0137',
'OH0232',
'OH0101',
'OH0102',
'OH0146',
'OH0103',
'OH0104',
'OH0105',
'OH0241',
'OH0106',
'OH0235',
'OH0188',
'OH0060',
'OH0108',
'OH0139',
'OH0084',
'OH0110',
'OH0112',
'OH0113',
'OH0114',
'OH0115',
'OH0100',
'OH0117',
'OH0118',
'OH0122',
'OH0120',
'OH0163',
'OH0121',
'OH0021',
'OH0123',
'OH0124',
'OH0125',
'OH0126',
'OH0127',
'OH0128',
'OH0130',
'OH0097',
'OH0132',
'OH0202',
'OH0231',
'OH0111',
'OH0134',
'OH0135',
'OH0136',
'OH0138',
'OH0166',
'OH0140',
'OH0141',
'OH0187',
'OH0142',
'OH0043',
'OH0144',
'OH0145',
'OH0236',
'OH0147',
'OH0212',
'OH0244',
'OH0148',
'OH0149',
'OH0177',
'OH0151',
'OH0152',
'OH0250',
'OH0155',
'OH0157',
'OH0159',
'OH0160',
'OH0162',
'OH0164',
'OH0165',
'OH0080',
'OH0167',
'OH0168',
'OH0169',
'OH0170',
'OH0171',
'OH0173',
'OH0174',
'OH0178',
'OH0069',
'OH0179',
'OH0180',
'OH0181',
'OH0201',
'OH0158',
'OH0182',
'OH0050',
'OH0184',
'OH0185',
'OH0186',
'OH0089',
'OH0189',
'OH0075',
'OH0049',
'OH0153',
'OH0208',
'OH0248',
'OH0035',
'OH0176',
'OH0190',
'OH0191',
'OH0154',
'OH0222',
'OH0193',
'OH0194',
'OH0195',
'OH0005',
'OH0196',
'OH0197',
'OH0198',
'OH0150',
'OH0199',
'OH0047',
'OH0014',
'OH0200',
'OH0203',
'OH0099',
'OH0205',
'OH0206',
'OH0207',
'OH0039',
'OH0209',
'OH0211',
'OH0233',
'OH0213',
'OH0214',
'OH0215',
'OH0216',
'OH0161',
'OH0217',
'OH0192',
'OH0218',
'OH0219',
'OH0224',
'OH0251',
'OH0226',
'OH0131',
'OH0045',
'OH0228',
'OH0183',
'OH0245',
'OH0230',
'OH0234',
'OH0237',
'OH0238',
'OH0239',
'OH0240',
'OH0032',
'OH0242',
'OH0243',
'OH0029',
'OH0223',
'OH0011',
'OH0246',
'OH0172']



data = pd.DataFrame()

for LibraryID in values:
    url = 'https://stats.oplin.org/lynda/'
    myobj = {'fscs': LibraryID}
    x = requests.post(url, data = myobj)
    ls = pd.read_html(x.text)
    tempdf = pd.DataFrame(ls[0])
    tempdf['Library ID'] = LibraryID
    data = data.append(tempdf, ignore_index = True)

data = data.merge(libraryDf, on = 'Library ID' )
data['Date'] = pd.to_datetime(data['Month'], format = '%Y-%m', errors = 'coerce')
data = data.drop(columns = 'Month')


dataPivot = pd.melt(data, id_vars = ['Library ID','Library Name','Date'], 
                    value_vars = ['Total Users',
                                  'New Users',
                                  'Logins',
                                  'Unique Logins',
                                  'Videos',
                                  'Video Hours',
                                  'Certs Earned',
                                  'Cert Earners'],
                    var_name = 'Metric', value_name = 'Value')
        
data.to_csv('OplinData.csv')
dataPivot.to_csv('LyndaPivot.csv')